#INFO: **** input file is /home/jluis/src/git/scripts/chf/test/chf.py ****
#!/usr/bin/env python

import numpy
from functools import reduce
from pyscf import gto, scf, lo, dft, lib
from pyscf.tools import wfn_format, molden

def get_pop(dm, s, lmultipliers):

    label = mol.spheric_labels(False)

    #pop = numpy.einsum('ij,ji->i', dm,s)
    #chg1 = numpy.zeros(mol.natm)
    #qq1 = numpy.zeros(mol.natm)
    #for i, s1 in enumerate(label):
    #    chg1[s1[0]] += pop[i]
    #for ia in range(mol.natm):
    #    symb = mol.atom_symbol(ia)
    #    qq1[ia] = mol.atom_charge(ia)-chg1[ia]
    #    lib.logger.info(mf, 'Pop, Q, of %d %s = %12.6f %12.6f' \
    #    % (ia+1, symb, chg1[ia], qq1[ia]))

    nao = dm.shape[0]
    fock = numpy.zeros_like(dm)
    for ia in range(mol.natm):
        g = numpy.zeros_like(dm)
        iden = numpy.zeros_like(dm)
        for i, s1 in enumerate(label):
            if (s1[0]==ia):
                iden[i,:] = 1.0
        iden = 0.5*(iden+iden.T)
        #print iden
        #tmp = numpy.einsum('ij,ji->ij',iden,s)
        #tmp = numpy.einsum('ij,ji->',tmp,dm)
        #lib.logger.info(mf, 'Pop of %d = %12.6f' % (ia+1, tmp))
        g = numpy.einsum('ij,ji->ij', iden,s)
        fock += lmultipliers[ia]*g

    return fock

def get_cfock(h1e, s1e, vhf, dm, cycle=0, mf_diis=None):
    fock = old_get_fock(h1e, s1e, vhf, dm, cycle, mf_diis)
    fock -= get_pop(dm, s1e, multiplicadores) 
    return fock

mol = gto.Mole()
mol.verbose = 4
mol.atom = '''
H  0.000000000000000  0.000000000000000  0.000000000000000
H  0.000000000000000  0.000000000000000  0.750000000000000
'''
#Li  0.000000000000000  0.000000000000000  0.000000000000000
#F   0.000000000000000  0.000000000000000  1.600000000000000
mol.basis = 'sto-3g'
mol.spin = 0
mol.charge = 0
mol.symmetry = 0
mol.build()

mf = scf.RHF(mol)
mf.verbose = 0
mf.kernel()
dm = mf.make_rdm1()

multiplicadores = numpy.zeros(mol.natm)

my_diis_obj = scf.ADIIS()
my_diis_obj.diis_space = 14

x = [-0.1, -0.2, -0.3, -0.4, -0.5, -0.6, -0.7, -0.8, -0.9, -1.0, 0.0,
0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1.0]
x = numpy.asarray(x)
ehf = []

#for b in x:
#    multiplicadores = [0.0,b]

multiplicadores = [0.0,0.1]
mf = scf.RHF(mol)
mf.conv_tol = 1e-6
mf.max_cycle = 120
mf.diis = my_diis_obj
old_get_fock = mf.get_fock
mf.get_fock = get_cfock 
#mf.verbose = 3
ehf.append(mf.kernel(dm0=dm))
mf.analyze(with_meta_lowdin=False)
dm = mf.make_rdm1()

name = 'h2_0p1'    
wfn_file = name + '.wfn'
with open(wfn_file, 'w') as f2:
    wfn_format.write_mo(f2, mol, mf.mo_coeff[:,mf.mo_occ>0], \
    mo_occ=mf.mo_occ[mf.mo_occ>0], mo_energy=mf.mo_energy[mf.mo_occ>0])

#INFO: ******************** input file end ********************


System: ('Linux', 'silicio', '3.16.0-4-amd64', '#1 SMP Debian 3.16.51-3 (2017-12-13)', 'x86_64', '')  Threads 12
Python 2.7.15 (default, Oct 25 2018, 01:35:55) 
[GCC 8.2.0]
numpy 1.15.3  scipy 1.1.0
Date: Thu Nov  1 03:03:54 2018
PySCF version 1.6a
PySCF path  /home/jluis/src/pyscf/dev/pyscf
GIT ORIG_HEAD 090d7a77795211ecfcdfc6ced606736fde25d1c7
GIT HEAD      ref: refs/heads/dev
GIT dev branch  27eb228cd9fdd7aebc89cf429224ff485f9c21c4

[ENV] PYSCF_TMPDIR /scratch-ssd/jluis
[CONFIG] conf_file None
[INPUT] verbose = 4
[INPUT] num. atoms = 2
[INPUT] num. electrons = 2
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry 0 subgroup None
[INPUT] Mole.unit = angstrom
[INPUT]  1 H      0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr
[INPUT]  2 H      0.000000000000   0.000000000000   0.750000000000 AA    0.000000000000   0.000000000000   1.417294593424 Bohr

nuclear repulsion = 0.70556961456
number of shells = 2
number of NR pGTOs = 6
number of NR cGTOs = 2
basis = sto-3g
ecp = {}
CPU time:         0.35


******** <class 'pyscf.scf.hf.RHF'> ********
method = RHF
initial guess = minao
damping factor = 0
level shift factor = 0
DIIS = <pyscf.scf.diis.ADIIS object at 0x2b13f2662710>
DIIS start cycle = 1
DIIS space = 6
SCF tol = 1e-06
SCF gradient tol = None
max. SCF cycles = 120
direct_scf = True
direct_scf_tol = 1e-13
chkfile to save SCF result = /scratch-ssd/jluis/tmpOhnSNX
max_memory 4000 MB (current use 70 MB)
Set gradient conv threshold to 0.001
init E= -1.1161514489386
  HOMO = -0.627957372638366  LUMO = 0.614430865648383
cycle= 1 E= -1.10981643357851  delta_E= 0.00634  |g|= 0.0126  |ddm|= 0.199
  HOMO = -0.627326046423829  LUMO = 0.61386462638463
cycle= 2 E= -1.10855319953738  delta_E= 0.00126  |g|= 0.00123  |ddm|= 0.0192
  HOMO = -0.627326046423829  LUMO = 0.61386462638463
cycle= 3 E= -1.10855319953738  delta_E=    0  |g|= 0.00123  |ddm|=    0
  HOMO = -0.627326046423829  LUMO = 0.61386462638463
cycle= 4 E= -1.10855319953738  delta_E=    0  |g|= 0.00123  |ddm|=    0
  HOMO = -0.627326046423829  LUMO = 0.61386462638463
cycle= 5 E= -1.10855319953738  delta_E=    0  |g|= 0.00123  |ddm|= 2.29e-16
  HOMO = -0.627326046423829  LUMO = 0.61386462638463
cycle= 6 E= -1.10855319953738  delta_E=    0  |g|= 0.00123  |ddm|= 2.29e-16
  HOMO = -0.627326046423829  LUMO = 0.613864626384629
cycle= 7 E= -1.10855319953738  delta_E=    0  |g|= 0.00123  |ddm|= 2.12e-15
  HOMO = -0.627131172879383  LUMO = 0.613682744989224
cycle= 8 E= -1.10842382099661  delta_E= 0.000129  |g|= 0.00012  |ddm|= 0.00187
  HOMO = -0.627131172879383  LUMO = 0.613682744989225
cycle= 9 E= -1.10842382099661  delta_E=    0  |g|= 0.00012  |ddm|=    0
  HOMO = -0.627110904723702  LUMO = 0.613663807723632
Extra cycle  E= -1.10841110979128  delta_E= 1.27e-05  |g|= 1.18e-05  |ddm|= 0.000183
converged SCF energy = -1.10841110979128
**** MO energy ****
MO #1   energy= -0.627110904723702 occ= 2
MO #2   energy= 0.613663807723632  occ= 0
 ** Mulliken pop  **
pop of  0 H 1s        0.84480
pop of  1 H 1s        1.15520
 ** Mulliken atomic charges  **
charge of  0H =      0.15520
charge of  1H =     -0.15520
Dipole moment(X, Y, Z, Debye):  0.00000,  0.00000, -0.55908
