#INFO: **** input file is /home/jluis/src/git/scripts/chf/test2/chf.py ****
#!/usr/bin/env python

import numpy, sys
from functools import reduce
from pyscf import gto, scf, lo, dft, lib, ao2mo
from pyscf.tools import wfn_format, molden

def get_pop(dm, s, lmultipliers):

    label = mol.spheric_labels(False)

    #pop = numpy.einsum('ij,ji->i', dm,s)
    #chg1 = numpy.zeros(mol.natm)
    #qq1 = numpy.zeros(mol.natm)
    #for i, s1 in enumerate(label):
    #    chg1[s1[0]] += pop[i]
    #for ia in range(mol.natm):
    #    symb = mol.atom_symbol(ia)
    #    qq1[ia] = mol.atom_charge(ia)-chg1[ia]
    #    lib.logger.info(mf, 'Pop, Q, of %d %s = %12.6f %12.6f' \
    #    % (ia+1, symb, chg1[ia], qq1[ia]))

    nao = dm.shape[0]
    fock = numpy.zeros_like(dm)
    for ia in range(mol.natm):
        g = numpy.zeros_like(dm)
        iden = numpy.zeros_like(dm)
        for i, s1 in enumerate(label):
            if (s1[0]==ia):
                iden[i,:] = 1.0
        iden = 0.5*(iden+iden.T)
        #print iden
        #tmp = numpy.einsum('ij,ji->ij',iden,s)
        #tmp = numpy.einsum('ij,ji->',tmp,dm)
        #lib.logger.info(mf, 'Pop of %d = %12.6f' % (ia+1, tmp))
        g = numpy.einsum('ij,ji->ij', iden,s)
        fock += lmultipliers[ia]*g

    return fock

def get_cfock(h1e, s1e, vhf, dm, cycle=0, mf_diis=None):
    fock = old_get_fock(h1e, s1e, vhf, dm, cycle, mf_diis)
    fock -= get_pop(dm, s1e, multiplicadores) 
    return fock

mol = gto.Mole()
mol.verbose = 4
mol.atom = '''
Li  0.000000000000000  0.000000000000000  0.000000000000000
F   0.000000000000000  0.000000000000000  1.563900000000000
'''
mol.basis = '6-31g'
mol.spin = 0
mol.charge = 0
mol.symmetry = 0
mol.build()

mf = scf.RHF(mol)
mf.verbose = 0
mf.kernel()
dm = mf.make_rdm1()

multiplicadores = numpy.zeros(mol.natm)

my_diis_obj = scf.ADIIS()
my_diis_obj.diis_space = 24
my_diis_obj.diis_start_cycle = 14

x = [-0.1, -0.2, -0.3, -0.4, -0.5, -0.6, -0.7, -0.8, -0.9, -1.0, 0.0,
0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1.0]
x = numpy.asarray(x)
ehf = []

#for b in x:
#    multiplicadores = [0.0,b]

multiplicadores = [0.00,2.00]
mf = scf.RHF(mol)
mf.conv_tol = 1e-6
mf.max_cycle = 120
mf.diis = my_diis_obj
mf.init_guess = 'hcore'
mf.level_shift = 0.8
old_get_fock = mf.get_fock
mf.get_fock = get_cfock 
#mf.verbose = 3
ehf.append(mf.kernel(dm0=dm))
mf.analyze(with_meta_lowdin=False)
dm = mf.make_rdm1()

name = 'lif_2p0'    
wfn_file = name + '.wfn'
with open(wfn_file, 'w') as f2:
    wfn_format.write_mo(f2, mol, mf.mo_coeff[:,mf.mo_occ>0], \
    mo_occ=mf.mo_occ[mf.mo_occ>0], mo_energy=mf.mo_energy[mf.mo_occ>0])

#INFO: ******************** input file end ********************


System: ('Linux', 'silicio', '3.16.0-4-amd64', '#1 SMP Debian 3.16.51-3 (2017-12-13)', 'x86_64', '')  Threads 12
Python 2.7.15 (default, Oct 25 2018, 01:35:55) 
[GCC 8.2.0]
numpy 1.15.3  scipy 1.1.0
Date: Thu Nov  1 04:33:36 2018
PySCF version 1.6a
PySCF path  /home/jluis/src/pyscf/dev/pyscf
GIT ORIG_HEAD 090d7a77795211ecfcdfc6ced606736fde25d1c7
GIT HEAD      ref: refs/heads/dev
GIT dev branch  27eb228cd9fdd7aebc89cf429224ff485f9c21c4

[ENV] PYSCF_TMPDIR /scratch-ssd/jluis
[CONFIG] conf_file None
[INPUT] verbose = 4
[INPUT] num. atoms = 2
[INPUT] num. electrons = 12
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry 0 subgroup None
[INPUT] Mole.unit = angstrom
[INPUT]  1 Li     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr
[INPUT]  2 F      0.000000000000   0.000000000000   1.563900000000 AA    0.000000000000   0.000000000000   2.955342686207 Bohr

nuclear repulsion = 9.13599635196624
number of shells = 10
number of NR pGTOs = 44
number of NR cGTOs = 18
basis = 6-31g
ecp = {}
CPU time:         0.35


******** <class 'pyscf.scf.hf.RHF'> ********
method = RHF
initial guess = hcore
damping factor = 0
level shift factor = 0.8
DIIS = <pyscf.scf.diis.ADIIS object at 0x2b100f441750>
DIIS start cycle = 1
DIIS space = 6
SCF tol = 1e-06
SCF gradient tol = None
max. SCF cycles = 120
direct_scf = True
direct_scf_tol = 1e-13
chkfile to save SCF result = /scratch-ssd/jluis/tmpKylIzL
max_memory 4000 MB (current use 70 MB)
Set gradient conv threshold to 0.001
init E= -106.920889785846
  HOMO = -2.33324290596713  LUMO = 0.425845282453829
cycle= 1 E= -106.697592568137  delta_E= 0.223  |g|= 0.65  |ddm|= 2.04
  HOMO = -2.3389068323652  LUMO = 0.466124215559191
cycle= 2 E= -106.572124862555  delta_E= 0.125  |g|= 0.174  |ddm|= 0.658
  HOMO = -2.33965615431752  LUMO = 0.466185641191492
cycle= 3 E= -106.544263140321  delta_E= 0.0279  |g|= 0.0861  |ddm|= 0.121
  HOMO = -2.33970014017053  LUMO = 0.466190351257634
cycle= 4 E= -106.538277974834  delta_E= 0.00599  |g|= 0.069  |ddm|= 0.0225
  HOMO = -2.33970297031084  LUMO = 0.466190713765355
cycle= 5 E= -106.536941517732  delta_E= 0.00134  |g|= 0.0653  |ddm|= 0.00447
  HOMO = -2.33970316567287  LUMO = 0.466190741671152
cycle= 6 E= -106.536629785925  delta_E= 0.000312  |g|= 0.0644  |ddm|= 0.000963
  HOMO = -2.33970317984912  LUMO = 0.466190743819359
cycle= 7 E= -106.536554348528  delta_E= 7.54e-05  |g|= 0.0642  |ddm|= 0.000223
  HOMO = -2.35378333275385  LUMO = 0.455349253889057
cycle= 8 E= -106.525945833818  delta_E= 0.0106  |g|= 0.0282  |ddm|= 0.0452
  HOMO = -2.35655879477696  LUMO = 0.453648932928651
cycle= 9 E= -106.521249098967  delta_E= 0.0047  |g|= 0.0182  |ddm|= 0.0173
  HOMO = -2.35696954984351  LUMO = 0.453610520589863
cycle= 10 E= -106.519603003062  delta_E= 0.00165  |g|= 0.0173  |ddm|= 0.0054
  HOMO = -2.35700897166681  LUMO = 0.453689802672247
cycle= 11 E= -106.519070600966  delta_E= 0.000532  |g|= 0.0173  |ddm|= 0.00161
  HOMO = -2.35700508686222  LUMO = 0.453729929037491
cycle= 12 E= -106.518904703025  delta_E= 0.000166  |g|= 0.0172  |ddm|= 0.000471
  HOMO = -2.35700099864733  LUMO = 0.453744816867181
cycle= 13 E= -106.518854136168  delta_E= 5.06e-05  |g|= 0.0172  |ddm|= 0.000138
  HOMO = -2.35427720212541  LUMO = 0.457657064317589
cycle= 14 E= -106.517133232981  delta_E= 0.00172  |g|= 0.00663  |ddm|= 0.0112
  HOMO = -2.35302819782718  LUMO = 0.459490321005289
cycle= 15 E= -106.516032225304  delta_E= 0.0011  |g|= 0.00315  |ddm|= 0.00692
  HOMO = -2.35265341303333  LUMO = 0.460076546029296
cycle= 16 E= -106.515555765514  delta_E= 0.000476  |g|= 0.00549  |ddm|= 0.00285
  HOMO = -2.35256506255764  LUMO = 0.460233141238754
cycle= 17 E= -106.515381231061  delta_E= 0.000175  |g|= 0.00656  |ddm|= 0.000975
  HOMO = -2.35254955698046  LUMO = 0.460269418014583
cycle= 18 E= -106.515322594104  delta_E= 5.86e-05  |g|= 0.00691  |ddm|= 0.000299
  HOMO = -2.35254868920989  LUMO = 0.460276397842955
cycle= 19 E= -106.515303824581  delta_E= 1.88e-05  |g|= 0.00702  |ddm|= 8.49e-05
  HOMO = -2.35381259759534  LUMO = 0.458716990430355
cycle= 20 E= -106.515366749201  delta_E= -6.29e-05  |g|= 0.00347  |ddm|= 0.00225
  HOMO = -2.35470502895036  LUMO = 0.457623677856594
cycle= 21 E= -106.515422833224  delta_E= -5.61e-05  |g|= 0.000628  |ddm|= 0.00221
  HOMO = -2.35511244009582  LUMO = 0.457130328146357
cycle= 22 E= -106.515447446896  delta_E= -2.46e-05  |g|= 0.00223  |ddm|= 0.00132
  HOMO = -2.35414099928399  LUMO = 0.458366594798301
cycle= 23 E= -106.515223540954  delta_E= 0.000224  |g|= 0.000295  |ddm|= 0.00201
  HOMO = -2.35414102159415  LUMO = 0.458366621002473
cycle= 24 E= -106.515186364107  delta_E= 3.72e-05  |g|= 0.00087  |ddm|= 0.000422
  HOMO = -2.35414102332755  LUMO = 0.458366623018381
cycle= 25 E= -106.51518060869  delta_E= 5.76e-06  |g|= 0.00102  |ddm|= 9.77e-05
  HOMO = -2.35414102346371  LUMO = 0.458366623173404
cycle= 26 E= -106.515179870742  delta_E= 7.38e-07  |g|= 0.00106  |ddm|= 2.44e-05
  HOMO = -2.35414102347443  LUMO = 0.458366623185376
cycle= 27 E= -106.515179834918  delta_E= 3.58e-08  |g|= 0.00107  |ddm|= 6.39e-06
  HOMO = -2.35414102347529  LUMO = 0.458366623186283
cycle= 28 E= -106.515179859774  delta_E= -2.49e-08  |g|= 0.00108  |ddm|= 1.72e-06
  HOMO = -2.35444990809625  LUMO = 0.457981297605756
cycle= 29 E= -106.515217519938  delta_E= -3.77e-05  |g|= 0.000178  |ddm|= 0.000616
  HOMO = -2.3544378157949  LUMO = 0.45799595358526
cycle= 30 E= -106.515218061401  delta_E= -5.41e-07  |g|= 3.73e-05  |ddm|= 0.000121
  HOMO = -2.35441172309966  LUMO = 0.458028448627208
Extra cycle  E= -106.515211919382  delta_E= 6.14e-06  |g|= 8.92e-06  |ddm|= 4.01e-05
converged SCF energy = -106.515211919382
**** MO energy ****
MO #1   energy= -28.0873092756189  occ= 2
MO #2   energy= -3.51471030100361  occ= 2
MO #3   energy= -2.61767611940003  occ= 2
MO #4   energy= -2.42664178703352  occ= 2
MO #5   energy= -2.42664178703352  occ= 2
MO #6   energy= -2.35441172309966  occ= 2
MO #7   energy= 0.458028448627208  occ= 0
MO #8   energy= 0.458028448627209  occ= 0
MO #9   energy= 0.470625960536397  occ= 0
MO #10  energy= 0.616785646711835  occ= 0
MO #11  energy= 0.805237473159673  occ= 0
MO #12  energy= 0.893372656504476  occ= 0
MO #13  energy= 0.89337265650448   occ= 0
MO #14  energy= 0.974341083053902  occ= 0
MO #15  energy= 1.06747945120181   occ= 0
MO #16  energy= 1.08934215353396   occ= 0
MO #17  energy= 1.08934215353396   occ= 0
MO #18  energy= 1.83813667616169   occ= 0
 ** Mulliken pop  **
pop of  0 Li 1s        1.92030
pop of  0 Li 2s       -0.20722
pop of  0 Li 3s        0.07396
pop of  0 Li 2px      -0.02442
pop of  0 Li 2py      -0.02442
pop of  0 Li 2pz      -0.26005
pop of  0 Li 3px       0.00522
pop of  0 Li 3py       0.00522
pop of  0 Li 3pz       0.05252
pop of  1 F 1s        1.99764
pop of  1 F 2s        0.59458
pop of  1 F 3s        1.71054
pop of  1 F 2px       1.11036
pop of  1 F 2py       1.11036
pop of  1 F 2pz       1.08824
pop of  1 F 3px       0.90884
pop of  1 F 3py       0.90884
pop of  1 F 3pz       1.02949
 ** Mulliken atomic charges  **
charge of  0Li =      1.45888
charge of  1F =     -1.45888
Dipole moment(X, Y, Z, Debye):  0.00000,  0.00000, -7.42160
