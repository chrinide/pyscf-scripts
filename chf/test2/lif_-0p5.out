#INFO: **** input file is /home/jluis/src/git/scripts/chf/test2/chf.py ****
#!/usr/bin/env python

import numpy, sys
from functools import reduce
from pyscf import gto, scf, lo, dft, lib, ao2mo
from pyscf.tools import wfn_format, molden

def get_pop(dm, s, lmultipliers):

    label = mol.spheric_labels(False)

    #pop = numpy.einsum('ij,ji->i', dm,s)
    #chg1 = numpy.zeros(mol.natm)
    #qq1 = numpy.zeros(mol.natm)
    #for i, s1 in enumerate(label):
    #    chg1[s1[0]] += pop[i]
    #for ia in range(mol.natm):
    #    symb = mol.atom_symbol(ia)
    #    qq1[ia] = mol.atom_charge(ia)-chg1[ia]
    #    lib.logger.info(mf, 'Pop, Q, of %d %s = %12.6f %12.6f' \
    #    % (ia+1, symb, chg1[ia], qq1[ia]))

    nao = dm.shape[0]
    fock = numpy.zeros_like(dm)
    for ia in range(mol.natm):
        g = numpy.zeros_like(dm)
        iden = numpy.zeros_like(dm)
        for i, s1 in enumerate(label):
            if (s1[0]==ia):
                iden[i,:] = 1.0
        iden = 0.5*(iden+iden.T)
        #print iden
        #tmp = numpy.einsum('ij,ji->ij',iden,s)
        #tmp = numpy.einsum('ij,ji->',tmp,dm)
        #lib.logger.info(mf, 'Pop of %d = %12.6f' % (ia+1, tmp))
        g = numpy.einsum('ij,ji->ij', iden,s)
        fock += lmultipliers[ia]*g

    return fock

def get_cfock(h1e, s1e, vhf, dm, cycle=0, mf_diis=None):
    fock = old_get_fock(h1e, s1e, vhf, dm, cycle, mf_diis)
    fock -= get_pop(dm, s1e, multiplicadores) 
    return fock

mol = gto.Mole()
mol.verbose = 4
mol.atom = '''
Li  0.000000000000000  0.000000000000000  0.000000000000000
F   0.000000000000000  0.000000000000000  1.563900000000000
'''
mol.basis = '6-31g'
mol.spin = 0
mol.charge = 0
mol.symmetry = 0
mol.build()

mf = scf.RHF(mol)
mf.verbose = 0
mf.kernel()
dm = mf.make_rdm1()

multiplicadores = numpy.zeros(mol.natm)

my_diis_obj = scf.ADIIS()
my_diis_obj.diis_space = 14

x = [-0.1, -0.2, -0.3, -0.4, -0.5, -0.6, -0.7, -0.8, -0.9, -1.0, 0.0,
0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1.0]
x = numpy.asarray(x)
ehf = []

#for b in x:
#    multiplicadores = [0.0,b]

multiplicadores = [0.1,0.00]
mf = scf.RHF(mol)
mf.conv_tol = 1e-6
mf.max_cycle = 120
mf.diis = my_diis_obj
old_get_fock = mf.get_fock
mf.get_fock = get_cfock 
#mf.verbose = 3
ehf.append(mf.kernel(dm0=dm))
mf.analyze(with_meta_lowdin=False)
dm = mf.make_rdm1()

name = 'lif_-0p5'    
wfn_file = name + '.wfn'
with open(wfn_file, 'w') as f2:
    wfn_format.write_mo(f2, mol, mf.mo_coeff[:,mf.mo_occ>0], \
    mo_occ=mf.mo_occ[mf.mo_occ>0], mo_energy=mf.mo_energy[mf.mo_occ>0])

#INFO: ******************** input file end ********************


System: ('Linux', 'silicio', '3.16.0-4-amd64', '#1 SMP Debian 3.16.51-3 (2017-12-13)', 'x86_64', '')  Threads 12
Python 2.7.15 (default, Oct 25 2018, 01:35:55) 
[GCC 8.2.0]
numpy 1.15.3  scipy 1.1.0
Date: Thu Nov  1 03:55:11 2018
PySCF version 1.6a
PySCF path  /home/jluis/src/pyscf/dev/pyscf
GIT ORIG_HEAD 090d7a77795211ecfcdfc6ced606736fde25d1c7
GIT HEAD      ref: refs/heads/dev
GIT dev branch  27eb228cd9fdd7aebc89cf429224ff485f9c21c4

[ENV] PYSCF_TMPDIR /scratch-ssd/jluis
[CONFIG] conf_file None
[INPUT] verbose = 4
[INPUT] num. atoms = 2
[INPUT] num. electrons = 12
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry 0 subgroup None
[INPUT] Mole.unit = angstrom
[INPUT]  1 Li     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr
[INPUT]  2 F      0.000000000000   0.000000000000   1.563900000000 AA    0.000000000000   0.000000000000   2.955342686207 Bohr

nuclear repulsion = 9.13599635196624
number of shells = 10
number of NR pGTOs = 44
number of NR cGTOs = 18
basis = 6-31g
ecp = {}
CPU time:         0.26


******** <class 'pyscf.scf.hf.RHF'> ********
method = RHF
initial guess = minao
damping factor = 0
level shift factor = 0
DIIS = <pyscf.scf.diis.ADIIS object at 0x2af747546750>
DIIS start cycle = 1
DIIS space = 6
SCF tol = 1e-06
SCF gradient tol = None
max. SCF cycles = 120
direct_scf = True
direct_scf_tol = 1e-13
chkfile to save SCF result = /scratch-ssd/jluis/tmpRHAMRV
max_memory 4000 MB (current use 71 MB)
Set gradient conv threshold to 0.001
init E= -106.920889785846
  HOMO = -0.457773558035943  LUMO = -0.0959685130567657
cycle= 1 E= -106.912071784563  delta_E= 0.00882  |g|= 0.0719  |ddm|= 0.336
  HOMO = -0.504497944495199  LUMO = -0.0931492693144071
cycle= 2 E= -106.91279030019  delta_E= -0.000719  |g|= 0.0408  |ddm|= 0.0596
  HOMO = -0.482611367815565  LUMO = -0.0930959561061232
cycle= 3 E= -106.910195445133  delta_E= 0.00259  |g|= 0.0346  |ddm|= 0.052
  HOMO = -0.48261136781635  LUMO = -0.0930959561061235
cycle= 4 E= -106.910195445133  delta_E= -2.27e-13  |g|= 0.0346  |ddm|= 1.91e-12
  HOMO = -0.482611367815565  LUMO = -0.0930959561061232
cycle= 5 E= -106.910195445133  delta_E= 2.27e-13  |g|= 0.0346  |ddm|= 1.91e-12
  HOMO = -0.482611367815565  LUMO = -0.0930959561061232
cycle= 6 E= -106.910195445133  delta_E=    0  |g|= 0.0346  |ddm|=    0
  HOMO = -0.482611367815569  LUMO = -0.093095956106125
cycle= 7 E= -106.910195445133  delta_E=    0  |g|= 0.0346  |ddm|= 2.39e-14
  HOMO = -0.482611367815566  LUMO = -0.0930959561061246
cycle= 8 E= -106.910195445133  delta_E= -2.84e-14  |g|= 0.0346  |ddm|= 1.51e-14
  HOMO = -0.502512816516107  LUMO = -0.0925537424603282
cycle= 9 E= -106.911944841419  delta_E= -0.00175  |g|= 0.0267  |ddm|= 0.0394
  HOMO = -0.487269037602437  LUMO = -0.0928285605294343
cycle= 10 E= -106.910564246537  delta_E= 0.00138  |g|= 0.0213  |ddm|= 0.0303
  HOMO = -0.487269037602445  LUMO = -0.0928285605294328
cycle= 11 E= -106.910564246537  delta_E=    0  |g|= 0.0213  |ddm|= 2.95e-14
  HOMO = -0.487269037602438  LUMO = -0.0928285605294353
cycle= 12 E= -106.910564246537  delta_E= -1.42e-14  |g|= 0.0213  |ddm|= 2.22e-14
  HOMO = -0.487269037602438  LUMO = -0.0928285605294354
cycle= 13 E= -106.910564246537  delta_E= 9.95e-14  |g|= 0.0213  |ddm|= 2.76e-14
  HOMO = -0.487269037602438  LUMO = -0.0928285605294351
cycle= 14 E= -106.910564246537  delta_E= -2.84e-14  |g|= 0.0213  |ddm|= 2.2e-14
  HOMO = -0.487269037602437  LUMO = -0.0928285605294355
cycle= 15 E= -106.910564246537  delta_E= -2.84e-14  |g|= 0.0213  |ddm|= 1.23e-14
  HOMO = -0.499379578398875  LUMO = -0.0925633270827621
cycle= 16 E= -106.911694738024  delta_E= -0.00113  |g|= 0.0167  |ddm|= 0.0244
  HOMO = -0.489817217547479  LUMO = -0.0927562428665547
cycle= 17 E= -106.910835360016  delta_E= 0.000859  |g|= 0.0132  |ddm|= 0.019
  HOMO = -0.48981721754748  LUMO = -0.0927562428665506
cycle= 18 E= -106.910835360016  delta_E= -2.84e-14  |g|= 0.0132  |ddm|= 1.28e-14
  HOMO = -0.489817217547483  LUMO = -0.0927562428665504
cycle= 19 E= -106.910835360016  delta_E=    0  |g|= 0.0132  |ddm|= 1.17e-14
  HOMO = -0.489817217547482  LUMO = -0.0927562428665502
cycle= 20 E= -106.910835360016  delta_E= 4.26e-14  |g|= 0.0132  |ddm|= 1.34e-14
  HOMO = -0.489817217547479  LUMO = -0.0927562428665522
cycle= 21 E= -106.910835360016  delta_E= 5.68e-14  |g|= 0.0132  |ddm|= 2.52e-14
  HOMO = -0.489817217547522  LUMO = -0.0927562428665517
cycle= 22 E= -106.910835360016  delta_E= -4.26e-14  |g|= 0.0132  |ddm|= 8.84e-14
  HOMO = -0.497365154525719  LUMO = -0.0925974789702098
cycle= 23 E= -106.911537427141  delta_E= -0.000702  |g|= 0.0104  |ddm|= 0.0151
  HOMO = -0.491397656198456  LUMO = -0.0927203876907511
cycle= 24 E= -106.91099806405  delta_E= 0.000539  |g|= 0.00826  |ddm|= 0.0119
  HOMO = -0.491397656198452  LUMO = -0.0927203876907515
cycle= 25 E= -106.91099806405  delta_E= 4.26e-14  |g|= 0.00826  |ddm|= 2.67e-14
  HOMO = -0.491397656198473  LUMO = -0.0927203876907507
cycle= 26 E= -106.91099806405  delta_E= -1.42e-14  |g|= 0.00826  |ddm|= 5.32e-14
  HOMO = -0.491397656198451  LUMO = -0.0927203876907523
cycle= 27 E= -106.91099806405  delta_E= 5.68e-14  |g|= 0.00826  |ddm|= 4.71e-14
  HOMO = -0.49139765619848  LUMO = -0.0927203876907507
cycle= 28 E= -106.91099806405  delta_E= -1.42e-14  |g|= 0.00826  |ddm|= 5.9e-14
  HOMO = -0.491397656198567  LUMO = -0.0927203876907457
cycle= 29 E= -106.91099806405  delta_E= -5.68e-14  |g|= 0.00826  |ddm|= 1.79e-13
  HOMO = -0.49610809550574  LUMO = -0.0926222895210249
cycle= 30 E= -106.911433854797  delta_E= -0.000436  |g|= 0.00652  |ddm|= 0.00943
  HOMO = -0.492384872313071  LUMO = -0.0926993865045442
cycle= 31 E= -106.911095786681  delta_E= 0.000338  |g|= 0.00515  |ddm|= 0.00744
  HOMO = -0.4923848723131  LUMO = -0.0926993865045437
cycle= 32 E= -106.911095786681  delta_E= -4.26e-14  |g|= 0.00515  |ddm|= 6.31e-14
  HOMO = -0.492384872313113  LUMO = -0.0926993865045416
cycle= 33 E= -106.911095786681  delta_E=    0  |g|= 0.00515  |ddm|= 3.67e-14
  HOMO = -0.492384872313074  LUMO = -0.0926993865045427
cycle= 34 E= -106.911095786681  delta_E= 5.68e-14  |g|= 0.00515  |ddm|= 7.72e-14
  HOMO = -0.492384872313109  LUMO = -0.0926993865045417
cycle= 35 E= -106.911095786681  delta_E= -8.53e-14  |g|= 0.00515  |ddm|= 6.49e-14
  HOMO = -0.492384872313071  LUMO = -0.0926993865045408
cycle= 36 E= -106.911095786681  delta_E= 8.53e-14  |g|= 0.00515  |ddm|= 7.76e-14
  HOMO = -0.495324538767133  LUMO = -0.0926383374798887
cycle= 37 E= -106.911366726887  delta_E= -0.000271  |g|= 0.00407  |ddm|= 0.00588
  HOMO = -0.493001486305781  LUMO = -0.0926865135260301
cycle= 38 E= -106.91115514816  delta_E= 0.000212  |g|= 0.00321  |ddm|= 0.00465
  HOMO = -0.493001486305781  LUMO = -0.0926865135260309
cycle= 39 E= -106.91115514816  delta_E=    0  |g|= 0.00321  |ddm|= 1.64e-14
  HOMO = -0.493001486305783  LUMO = -0.0926865135260302
cycle= 40 E= -106.91115514816  delta_E= 4.26e-14  |g|= 0.00321  |ddm|= 2.46e-14
  HOMO = -0.493001486305781  LUMO = -0.0926865135260309
cycle= 41 E= -106.91115514816  delta_E=    0  |g|= 0.00321  |ddm|= 8.99e-15
  HOMO = -0.493001486305826  LUMO = -0.0926865135260308
cycle= 42 E= -106.91115514816  delta_E= -5.68e-14  |g|= 0.00321  |ddm|= 1.05e-13
  HOMO = -0.493001486305784  LUMO = -0.092686513526029
cycle= 43 E= -106.91115514816  delta_E= 4.26e-14  |g|= 0.00321  |ddm|= 1.08e-13
  HOMO = -0.494835972781878  LUMO = -0.0926484462899907
cycle= 44 E= -106.911323813073  delta_E= -0.000169  |g|= 0.00254  |ddm|= 0.00367
  HOMO = -0.493386491815793  LUMO = -0.0926785182065808
cycle= 45 E= -106.9111915388  delta_E= 0.000132  |g|= 0.00201  |ddm|= 0.0029
  HOMO = -0.493386491815719  LUMO = -0.0926785182065835
cycle= 46 E= -106.9111915388  delta_E= 4.26e-14  |g|= 0.00201  |ddm|= 1.58e-13
  HOMO = -0.493386491815718  LUMO = -0.0926785182065839
cycle= 47 E= -106.9111915388  delta_E= 7.11e-14  |g|= 0.00201  |ddm|= 2e-14
  HOMO = -0.49338649181584  LUMO = -0.0926785182065813
cycle= 48 E= -106.9111915388  delta_E= -8.53e-14  |g|= 0.00201  |ddm|= 2.44e-13
  HOMO = -0.493386491815801  LUMO = -0.0926785182065806
cycle= 49 E= -106.9111915388  delta_E= -1.42e-14  |g|= 0.00201  |ddm|= 9.05e-14
  HOMO = -0.493386491815869  LUMO = -0.0926785182065781
cycle= 50 E= -106.9111915388  delta_E= 5.68e-14  |g|= 0.00201  |ddm|= 1.52e-13
  HOMO = -0.49453125906433  LUMO = -0.0926547680360524
cycle= 51 E= -106.911296626355  delta_E= -0.000105  |g|= 0.00158  |ddm|= 0.00229
  HOMO = -0.493626828407371  LUMO = -0.0926735336480368
cycle= 52 E= -106.911213989306  delta_E= 8.26e-05  |g|= 0.00125  |ddm|= 0.00181
  HOMO = -0.49362682840755  LUMO = -0.0926735336480325
cycle= 53 E= -106.911213989306  delta_E= -5.68e-14  |g|= 0.00125  |ddm|= 3.6e-13
  HOMO = -0.493626828407459  LUMO = -0.0926735336480342
cycle= 54 E= -106.911213989306  delta_E= 2.84e-14  |g|= 0.00125  |ddm|= 1.97e-13
  HOMO = -0.493626828407298  LUMO = -0.0926735336480392
cycle= 55 E= -106.911213989306  delta_E= -1.42e-14  |g|= 0.00125  |ddm|= 3.19e-13
  HOMO = -0.4936268284073  LUMO = -0.0926735336480354
cycle= 56 E= -106.911213989306  delta_E= -4.26e-14  |g|= 0.00125  |ddm|= 1.61e-14
  HOMO = -0.493626828408048  LUMO = -0.0926735336480215
cycle= 57 E= -106.911213989306  delta_E= -2.84e-14  |g|= 0.00125  |ddm|= 1.5e-12
  HOMO = -0.494341178836529  LUMO = -0.0926587137079949
cycle= 58 E= -106.911279501173  delta_E= -6.55e-05  |g|= 0.000989  |ddm|= 0.00143
  HOMO = -0.493776834550972  LUMO = -0.0926704230714685
cycle= 59 E= -106.91122789751  delta_E= 5.16e-05  |g|= 0.000781  |ddm|= 0.00113
  HOMO = -0.493776834551057  LUMO = -0.0926704230714637
cycle= 60 E= -106.911227897511  delta_E= -5.68e-14  |g|= 0.000781  |ddm|= 1.66e-13
  HOMO = -0.494222593515293  LUMO = -0.0926611752568147
Extra cycle  E= -106.911268752224  delta_E= -4.09e-05  |g|= 0.000617  |ddm|= 0.000892
converged SCF energy = -106.911268752224
**** MO energy ****
MO #1   energy= -26.1566086103708  occ= 2
MO #2   energy= -2.54391065608782  occ= 2
MO #3   energy= -1.4022715060629   occ= 2
MO #4   energy= -0.517565709117532 occ= 2
MO #5   energy= -0.494222593515297 occ= 2
MO #6   energy= -0.494222593515293 occ= 2
MO #7   energy= -0.0926611752568147 occ= 0
MO #8   energy= -0.0243252526164334 occ= 0
MO #9   energy= -0.0243252526164332 occ= 0
MO #10  energy= 0.0229665396459472 occ= 0
MO #11  energy= 0.10809875299601   occ= 0
MO #12  energy= 0.144606499915886  occ= 0
MO #13  energy= 0.144606499915893  occ= 0
MO #14  energy= 0.296880772249224  occ= 0
MO #15  energy= 1.66508926507405   occ= 0
MO #16  energy= 1.66508926507405   occ= 0
MO #17  energy= 1.70503186778399   occ= 0
MO #18  energy= 2.15194187304852   occ= 0
 ** Mulliken pop  **
pop of  0 Li 1s        2.00042
pop of  0 Li 2s        0.10803
pop of  0 Li 3s       -0.02542
pop of  0 Li 2px       0.13585
pop of  0 Li 2py       0.13585
pop of  0 Li 2pz       0.08672
pop of  0 Li 3px      -0.00907
pop of  0 Li 3py      -0.00907
pop of  0 Li 3pz       0.01908
pop of  1 F 1s        1.99774
pop of  1 F 2s        0.93106
pop of  1 F 3s        1.00303
pop of  1 F 2px       1.07790
pop of  1 F 2py       1.07790
pop of  1 F 2pz       1.10009
pop of  1 F 3px       0.79531
pop of  1 F 3py       0.79531
pop of  1 F 3pz       0.77924
 ** Mulliken atomic charges  **
charge of  0Li =      0.55760
charge of  1F =     -0.55760
Dipole moment(X, Y, Z, Debye):  0.00000,  0.00000, -5.87277
