#INFO: **** input file is /home/jluis/src/git/scripts/chf/test2/chf.py ****
#!/usr/bin/env python

import numpy, sys
from functools import reduce
from pyscf import gto, scf, lo, dft, lib, ao2mo
from pyscf.tools import wfn_format, molden

def get_pop(dm, s, lmultipliers):

    label = mol.spheric_labels(False)

    #pop = numpy.einsum('ij,ji->i', dm,s)
    #chg1 = numpy.zeros(mol.natm)
    #qq1 = numpy.zeros(mol.natm)
    #for i, s1 in enumerate(label):
    #    chg1[s1[0]] += pop[i]
    #for ia in range(mol.natm):
    #    symb = mol.atom_symbol(ia)
    #    qq1[ia] = mol.atom_charge(ia)-chg1[ia]
    #    lib.logger.info(mf, 'Pop, Q, of %d %s = %12.6f %12.6f' \
    #    % (ia+1, symb, chg1[ia], qq1[ia]))

    nao = dm.shape[0]
    fock = numpy.zeros_like(dm)
    for ia in range(mol.natm):
        g = numpy.zeros_like(dm)
        iden = numpy.zeros_like(dm)
        for i, s1 in enumerate(label):
            if (s1[0]==ia):
                iden[i,:] = 1.0
        iden = 0.5*(iden+iden.T)
        #print iden
        #tmp = numpy.einsum('ij,ji->ij',iden,s)
        #tmp = numpy.einsum('ij,ji->',tmp,dm)
        #lib.logger.info(mf, 'Pop of %d = %12.6f' % (ia+1, tmp))
        g = numpy.einsum('ij,ji->ij', iden,s)
        fock += lmultipliers[ia]*g

    return fock

def get_cfock(h1e, s1e, vhf, dm, cycle=0, mf_diis=None):
    fock = old_get_fock(h1e, s1e, vhf, dm, cycle, mf_diis)
    fock -= get_pop(dm, s1e, multiplicadores) 
    return fock

mol = gto.Mole()
mol.verbose = 4
mol.atom = '''
Li  0.000000000000000  0.000000000000000  0.000000000000000
F   0.000000000000000  0.000000000000000  1.563900000000000
'''
mol.basis = '6-31g'
mol.spin = 0
mol.charge = 0
mol.symmetry = 0
mol.build()

mf = scf.RHF(mol)
mf.verbose = 0
mf.kernel()
dm = mf.make_rdm1()

multiplicadores = numpy.zeros(mol.natm)

my_diis_obj = scf.ADIIS()
my_diis_obj.diis_space = 24
my_diis_obj.diis_start_cycle = 14

x = [-0.1, -0.2, -0.3, -0.4, -0.5, -0.6, -0.7, -0.8, -0.9, -1.0, 0.0,
0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1.0]
x = numpy.asarray(x)
ehf = []

#for b in x:
#    multiplicadores = [0.0,b]

multiplicadores = [0.00,4.00]
mf = scf.RHF(mol)
mf.conv_tol = 1e-6
mf.max_cycle = 120
mf.diis = my_diis_obj
mf.init_guess = 'hcore'
mf.level_shift = 0.8
old_get_fock = mf.get_fock
mf.get_fock = get_cfock 
#mf.verbose = 3
ehf.append(mf.kernel(dm0=dm))
mf.analyze(with_meta_lowdin=False)
dm = mf.make_rdm1()

name = 'lif_4p0'    
wfn_file = name + '.wfn'
with open(wfn_file, 'w') as f2:
    wfn_format.write_mo(f2, mol, mf.mo_coeff[:,mf.mo_occ>0], \
    mo_occ=mf.mo_occ[mf.mo_occ>0], mo_energy=mf.mo_energy[mf.mo_occ>0])

#INFO: ******************** input file end ********************


System: ('Linux', 'silicio', '3.16.0-4-amd64', '#1 SMP Debian 3.16.51-3 (2017-12-13)', 'x86_64', '')  Threads 12
Python 2.7.15 (default, Oct 25 2018, 01:35:55) 
[GCC 8.2.0]
numpy 1.15.3  scipy 1.1.0
Date: Thu Nov  1 04:33:15 2018
PySCF version 1.6a
PySCF path  /home/jluis/src/pyscf/dev/pyscf
GIT ORIG_HEAD 090d7a77795211ecfcdfc6ced606736fde25d1c7
GIT HEAD      ref: refs/heads/dev
GIT dev branch  27eb228cd9fdd7aebc89cf429224ff485f9c21c4

[ENV] PYSCF_TMPDIR /scratch-ssd/jluis
[CONFIG] conf_file None
[INPUT] verbose = 4
[INPUT] num. atoms = 2
[INPUT] num. electrons = 12
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry 0 subgroup None
[INPUT] Mole.unit = angstrom
[INPUT]  1 Li     0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr
[INPUT]  2 F      0.000000000000   0.000000000000   1.563900000000 AA    0.000000000000   0.000000000000   2.955342686207 Bohr

nuclear repulsion = 9.13599635196624
number of shells = 10
number of NR pGTOs = 44
number of NR cGTOs = 18
basis = 6-31g
ecp = {}
CPU time:         0.33


******** <class 'pyscf.scf.hf.RHF'> ********
method = RHF
initial guess = hcore
damping factor = 0
level shift factor = 0.8
DIIS = <pyscf.scf.diis.ADIIS object at 0x2b8f78d27750>
DIIS start cycle = 1
DIIS space = 6
SCF tol = 1e-06
SCF gradient tol = None
max. SCF cycles = 120
direct_scf = True
direct_scf_tol = 1e-13
chkfile to save SCF result = /scratch-ssd/jluis/tmpjhCiCr
max_memory 4000 MB (current use 70 MB)
Set gradient conv threshold to 0.001
init E= -106.920889785846
  HOMO = -2.60776691810194  LUMO = -1.58746552002049
cycle= 1 E= -105.101184085741  delta_E= 1.82  |g|= 1.05  |ddm|= 4.36
  HOMO = -3.05468897512761  LUMO = -1.45868067494967
cycle= 2 E= -103.82092313791  delta_E= 1.28  |g|= 0.294  |ddm|= 1.58
  HOMO = -3.08130081818321  LUMO = -1.45835554785516
cycle= 3 E= -103.251450784702  delta_E= 0.569  |g|= 0.203  |ddm|= 0.521
  HOMO = -3.08621384300435  LUMO = -1.45833047611887
cycle= 4 E= -103.004003839238  delta_E= 0.247  |g|= 0.241  |ddm|= 0.209
  HOMO = -3.08712582940085  LUMO = -1.45832854015525
cycle= 5 E= -102.896988677584  delta_E= 0.107  |g|= 0.269  |ddm|= 0.0881
  HOMO = -3.08729525693915  LUMO = -1.45832839066005
cycle= 6 E= -102.850792938496  delta_E= 0.0462  |g|= 0.282  |ddm|= 0.0377
  HOMO = -3.0873267384418  LUMO = -1.458328379116
cycle= 7 E= -102.830867669078  delta_E= 0.0199  |g|= 0.288  |ddm|= 0.0162
  HOMO = -3.19963571541292  LUMO = -1.41289451870098
cycle= 8 E= -102.970280724268  delta_E= -0.139  |g|= 0.137  |ddm|= 0.139
  HOMO = -3.23485617281159  LUMO = -1.37564618136798
cycle= 9 E= -103.12640994089  delta_E= -0.156  |g|= 0.0377  |ddm|= 0.145
  HOMO = -3.26702247651918  LUMO = -1.40405975117214
cycle= 10 E= -103.123377614594  delta_E= 0.00303  |g|= 0.0134  |ddm|= 0.0264
  HOMO = -3.26702717968408  LUMO = -1.4040594270543
cycle= 11 E= -103.120292438753  delta_E= 0.00309  |g|= 0.0144  |ddm|= 0.00631
  HOMO = -3.26702782751296  LUMO = -1.40405940185409
cycle= 12 E= -103.118608470001  delta_E= 0.00168  |g|= 0.0156  |ddm|= 0.00193
  HOMO = -3.26702793316401  LUMO = -1.40405939989477
cycle= 13 E= -103.117811506271  delta_E= 0.000797  |g|= 0.016  |ddm|= 0.000711
  HOMO = -3.26702795117005  LUMO = -1.40405939974243
cycle= 14 E= -103.117455214464  delta_E= 0.000356  |g|= 0.0162  |ddm|= 0.000288
  HOMO = -3.26702795427266  LUMO = -1.40405939973059
cycle= 15 E= -103.1173002937  delta_E= 0.000155  |g|= 0.0162  |ddm|= 0.00012
  HOMO = -3.26494539203666  LUMO = -1.39851151105228
cycle= 16 E= -103.126747839689  delta_E= -0.00945  |g|= 0.00519  |ddm|= 0.0112
  HOMO = -3.26534659663436  LUMO = -1.39878240291176
cycle= 17 E= -103.128715266  delta_E= -0.00197  |g|= 0.00257  |ddm|= 0.00506
  HOMO = -3.26560506964789  LUMO = -1.39919522907824
cycle= 18 E= -103.128070282275  delta_E= 0.000645  |g|= 0.00139  |ddm|= 0.00253
  HOMO = -3.26560519422316  LUMO = -1.39919521595986
cycle= 19 E= -103.127726803213  delta_E= 0.000343  |g|= 0.0011  |ddm|= 0.000924
  HOMO = -3.2656052146541  LUMO = -1.39919521494004
cycle= 20 E= -103.127565720474  delta_E= 0.000161  |g|= 0.00103  |ddm|= 0.000359
  HOMO = -3.26560521801328  LUMO = -1.39919521486075
cycle= 21 E= -103.127493970945  delta_E= 7.17e-05  |g|= 0.00101  |ddm|= 0.000143
  HOMO = -3.26560521856627  LUMO = -1.39919521485459
cycle= 22 E= -103.127462813966  delta_E= 3.12e-05  |g|= 0.001  |ddm|= 5.74e-05
  HOMO = -3.26560521865741  LUMO = -1.39919521485411
cycle= 23 E= -103.127449469721  delta_E= 1.33e-05  |g|= 0.001  |ddm|= 2.32e-05
  HOMO = -3.26566365632627  LUMO = -1.39902202762766
cycle= 24 E= -103.127632465017  delta_E= -0.000183  |g|= 0.000639  |ddm|= 0.000732
  HOMO = -3.26569189795573  LUMO = -1.39896448342024
cycle= 25 E= -103.127787201416  delta_E= -0.000155  |g|= 0.000479  |ddm|= 0.000551
  HOMO = -3.26577254334785  LUMO = -1.39902294157696
cycle= 26 E= -103.127624606001  delta_E= 0.000163  |g|= 0.000273  |ddm|= 0.000582
  HOMO = -3.26577255105093  LUMO = -1.39902294138995
cycle= 27 E= -103.127546323495  delta_E= 7.83e-05  |g|= 0.000224  |ddm|= 0.000227
  HOMO = -3.26577255231151  LUMO = -1.39902294137541
cycle= 28 E= -103.127511069644  delta_E= 3.53e-05  |g|= 0.000213  |ddm|= 9.06e-05
  HOMO = -3.265772552518  LUMO = -1.39902294137428
cycle= 29 E= -103.127495667823  delta_E= 1.54e-05  |g|= 0.00021  |ddm|= 3.65e-05
  HOMO = -3.26577255255186  LUMO = -1.39902294137419
cycle= 30 E= -103.127489045998  delta_E= 6.62e-06  |g|= 0.000209  |ddm|= 1.47e-05
  HOMO = -3.26577255255741  LUMO = -1.39902294137419
cycle= 31 E= -103.127486224919  delta_E= 2.82e-06  |g|= 0.000209  |ddm|= 5.92e-06
  HOMO = -3.26578036707737  LUMO = -1.39898342617517
cycle= 32 E= -103.127544882908  delta_E= -5.87e-05  |g|= 0.000131  |ddm|= 0.000174
  HOMO = -3.26578491182674  LUMO = -1.39896995876255
cycle= 33 E= -103.1275938469  delta_E= -4.9e-05  |g|= 0.000101  |ddm|= 0.000136
  HOMO = -3.26579998364486  LUMO = -1.39898764169139
cycle= 34 E= -103.127559563575  delta_E= 3.43e-05  |g|= 5.85e-05  |ddm|= 0.000136
  HOMO = -3.26579998407289  LUMO = -1.39898764169006
cycle= 35 E= -103.127543376933  delta_E= 1.62e-05  |g|= 4.95e-05  |ddm|= 5.41e-05
  HOMO = -3.26579998414278  LUMO = -1.39898764168996
cycle= 36 E= -103.127536149401  delta_E= 7.23e-06  |g|= 4.75e-05  |ddm|= 2.18e-05
  HOMO = -3.2657999841542  LUMO = -1.39898764168994
cycle= 37 E= -103.127533003975  delta_E= 3.15e-06  |g|= 4.7e-05  |ddm|= 8.78e-06
  HOMO = -3.26579998415606  LUMO = -1.39898764168994
cycle= 38 E= -103.127531653913  delta_E= 1.35e-06  |g|= 4.68e-05  |ddm|= 3.54e-06
  HOMO = -3.26579998415637  LUMO = -1.39898764168995
cycle= 39 E= -103.127531079111  delta_E= 5.75e-07  |g|= 4.68e-05  |ddm|= 1.43e-06
  HOMO = -3.26580145800686  LUMO = -1.39897283329324
Extra cycle  E= -103.127558172896  delta_E= -2.71e-05  |g|= 2.33e-05  |ddm|= 6.68e-05
converged SCF energy = -103.127558172896
**** MO energy ****
MO #1   energy= -29.8203390548001  occ= 2
MO #2   energy= -5.70952862651066  occ= 2
MO #3   energy= -4.40522973067841  occ= 2
MO #4   energy= -4.26824721786775  occ= 2
MO #5   energy= -4.26824721786775  occ= 2
MO #6   energy= -3.26580145800686  occ= 2
MO #7   energy= -1.39897283329324  occ= 0
MO #8   energy= -1.39897283329323  occ= 0
MO #9   energy= -1.35677786361934  occ= 0
MO #10  energy= -1.27873023952752  occ= 0
MO #11  energy= 0.715031776022319  occ= 0
MO #12  energy= 0.885350048048816  occ= 0
MO #13  energy= 0.885350048048817  occ= 0
MO #14  energy= 0.893032302238911  occ= 0
MO #15  energy= 1.02180334893836   occ= 0
MO #16  energy= 1.02180334893837   occ= 0
MO #17  energy= 1.09524638475128   occ= 0
MO #18  energy= 2.33569709356498   occ= 0
 ** Mulliken pop  **
pop of  0 Li 1s        1.02995
pop of  0 Li 2s       -0.32930
pop of  0 Li 3s        0.13411
pop of  0 Li 2px      -0.03091
pop of  0 Li 2py      -0.03091
pop of  0 Li 2pz      -0.35635
pop of  0 Li 3px       0.00666
pop of  0 Li 3py       0.00666
pop of  0 Li 3pz       0.07450
pop of  1 F 1s        1.99752
pop of  1 F 2s        0.53102
pop of  1 F 3s        2.11474
pop of  1 F 2px       0.97425
pop of  1 F 2py       0.97425
pop of  1 F 2pz       1.38132
pop of  1 F 3px       1.05001
pop of  1 F 3py       1.05001
pop of  1 F 3pz       1.42248
 ** Mulliken atomic charges  **
charge of  0Li =      2.49561
charge of  1F =     -2.49561
Dipole moment(X, Y, Z, Debye):  0.00000, -0.00000, -11.98267
