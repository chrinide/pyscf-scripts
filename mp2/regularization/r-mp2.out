#INFO: **** input file is /home/jluis/src/git/scripts/mp2/regularization/r-mp2.py ****
#!/usr/bin/env python

import numpy
from pyscf import gto, scf, lib, ao2mo
from pyscf.tools import molden
einsum = lib.einsum

mol = gto.Mole()
mol.basis = 'aug-cc-pvdz'
mol.atom = '''
C  0.0000  0.0000  0.0000
H  0.6276  0.6276  0.6276
H  0.6276 -0.6276 -0.6276
H -0.6276  0.6276 -0.6276
H -0.6276 -0.6276  0.6276
'''
mol.charge = 0
mol.spin = 0
mol.symmetry = 1
mol.verbose = 4
mol.build()

mf = scf.RHF(mol)
ehf = mf.kernel()

nao, nmo = mf.mo_coeff.shape
ncore = 1
nocc = mol.nelectron//2 - ncore
nvir = nmo - nocc - ncore

mo_core = mf.mo_coeff[:,:ncore]
mo_occ = mf.mo_coeff[:,ncore:ncore+nocc]
mo_vir = mf.mo_coeff[:,ncore+nocc:]
co = mo_occ
cv = mo_vir
eo = mf.mo_energy[ncore:ncore+nocc]
ev = mf.mo_energy[ncore+nocc:]
eri_mo = ao2mo.general(mf._eri, (co,cv,co,cv), compact=False)
eri_mo = eri_mo.reshape(nocc,nvir,nocc,nvir)
lib.logger.info(mf,"* Core orbitals: %d" % ncore)
lib.logger.info(mf,"* Virtual orbitals: %d" % (len(ev)))
 
kappa = 1.45
e_denom = 1.0/(eo.reshape(-1,1,1,1)-ev.reshape(-1,1,1)+eo.reshape(-1,1)-ev)
t2 = numpy.zeros((nocc,nvir,nocc,nvir))
t2 = 2.0*einsum('iajb,iajb->iajb', eri_mo, e_denom)
t2 -= einsum('ibja,iajb->iajb', eri_mo, e_denom)
t2 = t2*(1.0-numpy.exp(-kappa*e_denom))
e_mp2 = numpy.einsum('iajb,iajb->', eri_mo, t2, optimize=True)
e_mp2 = -1.0*e_mp2
lib.logger.info(mf,"!*** E(MP2): %12.8f" % e_mp2)
lib.logger.info(mf,"!**** E(HF+MP2): %12.8f" % (e_mp2+ehf))

#INFO: ******************** input file end ********************


System: ('Linux', 'silicio', '3.16.0-4-amd64', '#1 SMP Debian 3.16.51-3 (2017-12-13)', 'x86_64', '')  Threads 12
Python 2.7.15 (default, Oct 25 2018, 01:35:55) 
[GCC 8.2.0]
numpy 1.15.3  scipy 1.1.0
Date: Tue Apr  2 11:30:01 2019
PySCF version 1.6.1
PySCF path  /home/jluis/src/pyscf/dev/pyscf
GIT ORIG_HEAD 4c522b64567e2ee224629dc3b97e6ab7eb8dbc91
GIT HEAD      ref: refs/heads/dev
GIT dev branch  efb4b7082c70842c74661e5fcb0f375a0c5c7506

[ENV] PYSCF_TMPDIR /scratch-ssd/jluis
[CONFIG] conf_file None
[INPUT] verbose = 4
[INPUT] num. atoms = 5
[INPUT] num. electrons = 10
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry 1 subgroup None
[INPUT] Mole.unit = angstrom
[INPUT]  1 C      0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr
[INPUT]  2 H      0.627600000000   0.627600000000   0.627600000000 AA    1.185992115777   1.185992115777   1.185992115777 Bohr
[INPUT]  3 H      0.627600000000  -0.627600000000  -0.627600000000 AA    1.185992115777  -1.185992115777  -1.185992115777 Bohr
[INPUT]  4 H     -0.627600000000   0.627600000000  -0.627600000000 AA   -1.185992115777   1.185992115777  -1.185992115777 Bohr
[INPUT]  5 H     -0.627600000000  -0.627600000000   0.627600000000 AA   -1.185992115777  -1.185992115777   1.185992115777 Bohr

nuclear repulsion = 13.4720345873821
point group symmetry = Td, use subgroup D2
num. orbitals of irrep A = 17
num. orbitals of irrep B1 = 14
num. orbitals of irrep B2 = 14
num. orbitals of irrep B3 = 14
number of shells = 28
number of NR pGTOs = 79
number of NR cGTOs = 59
basis = aug-cc-pvdz
ecp = {}
CPU time:         0.38


******** <class 'pyscf.scf.hf_symm.SymAdaptedRHF'> ********
method = SymAdaptedRHF-RHF
initial guess = minao
damping factor = 0
level shift factor = 0
DIIS = <class 'pyscf.scf.diis.CDIIS'>
DIIS start cycle = 1
DIIS space = 8
SCF tol = 1e-09
SCF gradient tol = None
max. SCF cycles = 50
direct_scf = True
direct_scf_tol = 1e-13
chkfile to save SCF result = /scratch-ssd/jluis/tmplMgJfq
max_memory 60000 MB (current use 66 MB)
Freeze 0 electrons in irreps []
    10 free electrons in irreps A B1 B2 B3
Set gradient conv threshold to 3.16228e-05
init E= -40.0359723685993
HOMO (B2) = -0.473861101908352  LUMO (A) = 0.0267081041528207
cycle= 1 E= -40.1919862026358  delta_E= -0.156  |g|= 0.147  |ddm|= 2.19
HOMO (B2) = -0.549685890140449  LUMO (A) = 0.0362501457683578
cycle= 2 E= -40.1990832745025  delta_E= -0.0071  |g|= 0.0351  |ddm|= 0.16
HOMO (B2) = -0.542356876823923  LUMO (A) = 0.0370385973585122
cycle= 3 E= -40.1996087990603  delta_E= -0.000526  |g|= 0.00528  |ddm|= 0.0455
HOMO (B3) = -0.544839057184445  LUMO (A) = 0.0369870790583862
cycle= 4 E= -40.1996171992774  delta_E= -8.4e-06  |g|= 0.00141  |ddm|= 0.00468
HOMO (B2) = -0.544377881382093  LUMO (A) = 0.0370031415749178
cycle= 5 E= -40.1996180529205  delta_E= -8.54e-07  |g|= 0.000234  |ddm|= 0.00178
HOMO (B2) = -0.544442046435407  LUMO (A) = 0.0370009243245654
cycle= 6 E= -40.19961807774  delta_E= -2.48e-08  |g|= 1.38e-05  |ddm|= 0.000357
HOMO (B1) = -0.544442986427914  LUMO (A) = 0.0370003830869247
cycle= 7 E= -40.1996180778241  delta_E= -8.41e-11  |g|= 9.64e-07  |ddm|= 3.62e-05
HOMO (B3) = -0.544442966189832  LUMO (A) = 0.0370003868004923
Extra cycle  E= -40.1996180778246  delta_E= -4.76e-13  |g|= 2.52e-07  |ddm|= 3.79e-06
converged SCF energy = -40.1996180778246
* Core orbitals: 1
* Virtual orbitals: 54
!*** E(MP2):  -0.11163818
!**** E(HF+MP2): -40.31125625
